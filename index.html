<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>OdontoCase</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore, collection, addDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBD...",
  authDomain: "odontocase-23a1a.firebaseapp.com",
  projectId: "odontocase-23a1a",
  storageBucket: "odontocase-23a1a.firebasestorage.app",
  messagingSenderId: "1008566809476",
  appId: "1:1008566809476:web:f80fe34f9445b316dfe3d1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

onAuthStateChanged(auth, user=>{
  if(!user) location.href="/login.html";
  else carregarCasos(user.uid);
});

window.logout=()=>signOut(auth);

window.salvarCaso = async function(){
  const user = auth.currentUser;
  const nome = document.getElementById("nome").value;
  const antes = document.getElementById("antes").files[0];
  const depois = document.getElementById("depois").files[0];

  const refAntes = ref(storage,`casos/${user.uid}/${Date.now()}_antes`);
  const refDepois = ref(storage,`casos/${user.uid}/${Date.now()}_depois`);

  await uploadBytes(refAntes,antes);
  await uploadBytes(refDepois,depois);

  const urlAntes = await getDownloadURL(refAntes);
  const urlDepois = await getDownloadURL(refDepois);

  await addDoc(collection(db,"usuarios",user.uid,"casos"),{
    nome,
    antes:urlAntes,
    depois:urlDepois,
    data:new Date()
  });

  alert("Caso salvo âœ”");
  carregarCasos(user.uid);
}

async function carregarCasos(uid){
  const querySnapshot = await getDocs(
    collection(db,"usuarios",uid,"casos")
  );
  const lista=document.getElementById("lista");
  lista.innerHTML="";
  querySnapshot.forEach(doc=>{
    const d=doc.data();
    lista.innerHTML+=`
    <div class="cardCaso">
      <b>${d.nome}</b><br>
      <img src="${d.antes}">
      <img src="${d.depois}">
    </div>`;
  });
}
</script>

<style>
body{margin:0;font-family:system-ui;background:#0b0d11;color:white}
.layout{display:flex;height:100vh}
.sidebar{
width:250px;background:#11141b;padding:25px
}
.sidebar h2{margin-top:0}
.sidebar button{
width:100%;padding:12px;margin-top:10px;
background:#1a1f2a;border:none;color:white;border-radius:8px
}

.main{flex:1;padding:30px;overflow:auto}
.box{
background:#11141b;padding:20px;border-radius:14px;margin-bottom:20px
}
input{padding:12px;margin-top:10px;width:100%;border-radius:8px;border:none;background:#0b0d11;color:white}
button.primary{
background:#e11d48;border:none;padding:12px;border-radius:8px;margin-top:10px;color:white;font-weight:600
}

.cardCaso{
background:#0b0d11;padding:15px;border-radius:10px;margin-top:10px
}
.cardCaso img{width:120px;margin-right:10px;border-radius:6px}
</style>
</head>

<body>

<div class="layout">

<div class="sidebar">
<h2>OdontoCase</h2>
<button>Dashboard</button>
<button onclick="logout()">Sair</button>
</div>

<div class="main">

<div class="box">
<h3>Novo Caso</h3>
<input id="nome" placeholder="Nome do paciente ou caso">
<input id="antes" type="file">
<input id="depois" type="file">
<button class="primary" onclick="salvarCaso()">Salvar Caso</button>
</div>

<div class="box">
<h3>Meus Casos</h3>
<div id="lista"></div>
</div>

</div>

</div>

</body>
</html>
